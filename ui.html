<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Variable Remapper</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg-primary: #ffffff; --bg-secondary: #f5f5f5; --bg-tertiary: #e5e5e5;
      --bg-hover: #f0f0f0; --bg-active: #e5e5e5;
      --text-primary: #000000; --text-secondary: #333333; --text-tertiary: #666666; --text-disabled: #999999;
      --border-strong: #d4d4d4; --border-medium: #e5e5e5; --border-subtle: #f0f0f0;
      --accent-primary: #18a0fb; --accent-hover: #0d8ce8; --accent-active: #0b7cd6;
      --success-bg: #d4edda; --success-text: #155724; --success-border: #c3e6cb;
      --warning-bg: #fff3cd; --warning-text: #856404; --warning-border: #ffc107;
      --error-bg: #f8d7da; --error-text: #dc3545; --error-border: #f5c6cb;
      --orphan-bg: #e8d4f8; --orphan-text: #6b21a8; --orphan-border: #c084fc;
    }
    [data-theme="dark"] {
      --bg-primary: #1e1e1e; --bg-secondary: #2c2c2c; --bg-tertiary: #3c3c3c;
      --bg-hover: #383838; --bg-active: #444444;
      --text-primary: #ffffff; --text-secondary: #e5e5e5; --text-tertiary: #b3b3b3; --text-disabled: #7a7a7a;
      --border-strong: #5a5a5a; --border-medium: #3c3c3c; --border-subtle: #2c2c2c;
      --accent-primary: #18a0fb; --accent-hover: #3db0ff; --accent-active: #0d8ce8;
      --success-bg: #1a3d28; --success-text: #4ade80; --success-border: #2d5a3d;
      --warning-bg: #3d3520; --warning-text: #fbbf24; --warning-border: #5a4d2d;
      --error-bg: #3d1a1a; --error-text: #f87171; --error-border: #5a2d2d;
      --orphan-bg: #3d2a4d; --orphan-text: #d8b4fe; --orphan-border: #7c3aed;
    }
    body { font-family: 'Inter', -apple-system, sans-serif; font-size: 12px; color: var(--text-secondary); background: var(--bg-primary); overflow: hidden; }
    .container { display: flex; flex-direction: column; height: 100vh; padding: 12px; }
    
    /* Find/Replace Section */
    .find-replace-section { background: var(--bg-secondary); border: 1px solid var(--border-medium); border-radius: 6px; padding: 12px; margin-bottom: 12px; }
    .find-replace-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .find-replace-row:last-child { margin-bottom: 0; }
    .input-group { display: flex; align-items: center; gap: 6px; flex: 1; }
    .input-group label { font-size: 11px; font-weight: 600; color: var(--text-tertiary); min-width: 50px; }
    .input-group input[type="text"] { flex: 1; padding: 6px 10px; border: 1px solid var(--border-strong); border-radius: 4px; font-size: 12px; background: var(--bg-primary); color: var(--text-secondary); }
    .input-group input[type="text"]:focus { outline: none; border-color: var(--accent-primary); }
    .options-row { display: flex; gap: 16px; align-items: center; }
    .checkbox-label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 11px; color: var(--text-tertiary); }
    .checkbox-label input[type="checkbox"] { cursor: pointer; }
    
    /* Preview Status Row */
    .preview-status-row { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
      margin-top: 10px; 
      padding-top: 10px; 
      border-top: 1px solid var(--border-medium);
      font-size: 11px;
    }
    .preview-status-row.hidden { display: none; }
    .preview-status-success { color: var(--success-text); font-weight: 500; }
    .preview-status-error { color: var(--error-text); font-weight: 500; }
    .preview-status-info { color: var(--text-tertiary); }
    
    /* Buttons */
    .btn { padding: 6px 12px; border: 1px solid var(--border-strong); border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer; background: var(--bg-secondary); color: var(--text-secondary); transition: all 0.15s ease; }
    .btn:hover { background: var(--bg-hover); }
    .btn-primary { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-apply-find-replace { padding: 6px 16px; }
    
    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--border-medium); border-radius: 6px; background: var(--bg-primary); }
    .columns-header { display: grid; grid-template-columns: 1fr 1fr; background: var(--bg-secondary); border-bottom: 1px solid var(--border-medium); font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; }
    .columns-header > div { padding: 8px 12px; }
    .columns-header > div:first-child { border-right: 1px solid var(--border-medium); }
    
    /* Property Groups */
    .property-groups { flex: 1; overflow-y: auto; overflow-x: hidden; }
    .property-group { border-bottom: 1px solid var(--border-medium); }
    .property-group:last-child { border-bottom: none; }
    .property-group-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); cursor: pointer; user-select: none; }
    .property-group-header:hover { background: var(--bg-hover); }
    .property-group-header-left { display: flex; align-items: center; gap: 8px; }
    .property-group-toggle { font-size: 10px; color: var(--text-tertiary); width: 16px; }
    .property-group-title { font-weight: 600; font-size: 12px; color: var(--text-primary); }
    .property-group-count { font-size: 11px; color: var(--text-tertiary); font-weight: 400; }
    .select-all-btn { font-size: 10px; padding: 2px 6px; background: transparent; border: 1px solid var(--border-strong); border-radius: 3px; cursor: pointer; color: var(--text-tertiary); }
    .select-all-btn:hover { background: var(--bg-hover); color: var(--text-secondary); }
    .property-group-items { display: none; }
    .property-group-items.expanded { display: block; }
    
    /* Binding Rows */
    .binding-row { display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid var(--border-subtle); }
    .binding-row:last-child { border-bottom: none; }
    .binding-row:hover { background: var(--bg-hover); }
    .binding-cell { padding: 8px 12px; display: flex; align-items: center; gap: 8px; font-size: 11px; font-family: 'SF Mono', 'Monaco', monospace; overflow: hidden; }
    .binding-cell:first-child { border-right: 1px solid var(--border-subtle); }
    .binding-checkbox { cursor: pointer; flex-shrink: 0; }
    .binding-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-secondary); }
    
    /* Count Badge - Improved contrast */
    .binding-count { 
      font-size: 11px; 
      font-weight: 600;
      color: var(--text-secondary); 
      background: var(--bg-tertiary); 
      padding: 2px 7px; 
      border-radius: 10px; 
      flex-shrink: 0; 
      cursor: help;
      border: 1px solid var(--border-strong);
      transition: all 0.15s ease;
    }
    .binding-count:hover {
      background: var(--accent-primary);
      color: white;
      border-color: var(--accent-primary);
    }
    
    .binding-preview { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .status-found { color: var(--success-text); }
    .status-not-found { color: var(--error-text); font-weight: 500; }
    .status-unchanged { color: var(--text-disabled); font-style: italic; cursor: default; }
    
    /* Warning Icon - Much more visible */
    .status-icon { 
      font-size: 14px; 
      flex-shrink: 0; 
      cursor: help;
      transition: transform 0.15s ease;
    }
    .status-icon:hover {
      transform: scale(1.2);
    }
    .status-icon-success { color: var(--success-text); }
    .status-icon-error { 
      color: var(--error-text); 
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      background: var(--error-bg);
      border: 1px solid var(--error-border);
      border-radius: 50%;
    }
    
    /* Tooltips - Fixed overflow and wrapping */
    .tooltip-wrapper {
      position: relative;
      display: inline-flex;
    }
    .tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a1a;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-family: 'Inter', -apple-system, sans-serif;
      font-weight: 400;
      line-height: 1.4;
      width: max-content;
      max-width: 240px;
      white-space: normal;
      text-align: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s ease, visibility 0.15s ease;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1a1a1a;
    }
    .tooltip-wrapper:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }
    /* Tooltip position variants */
    .tooltip-left {
      left: auto;
      right: 0;
      transform: translateX(0);
    }
    .tooltip-left::after {
      left: auto;
      right: 12px;
      transform: translateX(0);
    }
    
    /* Nested Instances */
    .nested-instances-section { padding: 8px 12px; background: var(--warning-bg); border-top: 1px solid var(--warning-border); font-size: 11px; color: var(--warning-text); }
    .nested-instances-section.hidden { display: none; }
    .nested-instances-title { font-weight: 600; margin-bottom: 4px; }
    .nested-instance-item { padding: 2px 0; }
    
    /* Footer */
    .footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; margin-top: 12px; border-top: 1px solid var(--border-medium); }
    .footer-left { display: flex; align-items: center; gap: 8px; }
    .footer-stats { font-size: 11px; color: var(--text-tertiary); }
    .footer-right { display: flex; align-items: center; gap: 8px; }
    
    /* Icon Buttons */
    .icon-button { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; border-radius: 4px; cursor: pointer; color: var(--text-tertiary); position: relative; }
    .icon-button:hover { background: var(--bg-hover); color: var(--text-secondary); }
    .icon-button:disabled { opacity: 0.3; cursor: not-allowed; }
    .icon-button:disabled:hover { background: transparent; color: var(--text-tertiary); }
    
    /* Icon Button Tooltips */
    .icon-button .btn-tooltip {
      position: absolute;
      bottom: calc(100% + 6px);
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a1a;
      color: #ffffff;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-family: 'Inter', -apple-system, sans-serif;
      white-space: nowrap;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s ease, visibility 0.15s ease;
      pointer-events: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .icon-button .btn-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #1a1a1a;
    }
    .icon-button:hover .btn-tooltip {
      opacity: 1;
      visibility: visible;
    }
    
    /* Undo/Redo Buttons */
    .undo-redo-group { display: flex; gap: 2px; margin-right: 8px; }
    .undo-redo-group .icon-button { 
      border: 1px solid var(--border-medium); 
      background: var(--bg-secondary);
    }
    .undo-redo-group .icon-button:hover:not(:disabled) { 
      background: var(--bg-hover); 
      border-color: var(--border-strong);
    }
    
    /* History Panel */
    .history-panel {
      position: absolute;
      bottom: 60px;
      right: 12px;
      width: 300px;
      max-height: 220px;
      background: var(--bg-primary);
      border: 1px solid var(--border-medium);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 100;
      display: none;
    }
    .history-panel.visible { display: block; }
    .history-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-medium);
      background: var(--bg-secondary);
      border-radius: 6px 6px 0 0;
    }
    .history-panel-title { font-weight: 600; font-size: 12px; color: var(--text-primary); }
    .history-panel-warning { 
      font-size: 10px; 
      color: var(--warning-text); 
      background: var(--warning-bg);
      padding: 2px 6px;
      border-radius: 3px;
      border: 1px solid var(--warning-border);
    }
    .history-panel-close { 
      background: none; 
      border: none; 
      cursor: pointer; 
      color: var(--text-tertiary);
      padding: 2px;
      font-size: 14px;
    }
    .history-panel-close:hover { color: var(--text-primary); }
    .history-panel-content {
      max-height: 160px;
      overflow-y: auto;
    }
    .history-item {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 11px;
      cursor: default;
    }
    .history-item:last-child { border-bottom: none; }
    .history-item.current { background: var(--accent-primary); color: white; }
    .history-item.future { opacity: 0.5; }
    .history-item-time { font-size: 10px; color: var(--text-disabled); margin-top: 2px; }
    .history-item.current .history-item-time { color: rgba(255,255,255,0.7); }
    .history-empty { padding: 20px; text-align: center; color: var(--text-disabled); font-size: 11px; }
    
    /* Empty State */
    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-disabled); padding: 40px; text-align: center; }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
    .empty-state-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; color: var(--text-tertiary); }
    .empty-state-desc { font-size: 12px; }
    
    /* Dialog */
    .dialog-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .dialog-overlay.hidden { display: none; }
    .dialog-box { background: var(--bg-primary); border-radius: 8px; padding: 20px; max-width: 360px; border: 1px solid var(--border-medium); }
    .dialog-title { font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
    .dialog-message { font-size: 12px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; }
    .dialog-actions { display: flex; gap: 8px; justify-content: flex-end; }
    
    /* Resize Handle */
    #resize-corner { position: absolute; right: 4px; bottom: 4px; cursor: nwse-resize; z-index: 10000; opacity: 0.4; color: var(--text-tertiary); }
    #resize-corner:hover { opacity: 0.8; }
    
    /* Scrollbar */
    .property-groups::-webkit-scrollbar, .history-panel-content::-webkit-scrollbar { width: 8px; }
    .property-groups::-webkit-scrollbar-track, .history-panel-content::-webkit-scrollbar-track { background: var(--bg-secondary); }
    .property-groups::-webkit-scrollbar-thumb, .history-panel-content::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 4px; }
    .property-groups::-webkit-scrollbar-thumb:hover, .history-panel-content::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }

    /* Tabs */
    .tabs { display: flex; gap: 0; margin-bottom: 12px; border-bottom: 1px solid var(--border-medium); }
    .tab { padding: 8px 16px; font-size: 12px; font-weight: 500; color: var(--text-tertiary); background: transparent; border: none; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.15s ease; }
    .tab:hover { color: var(--text-primary); background: var(--bg-hover); }
    .tab.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
    .tab-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 18px; height: 18px; padding: 0 5px; margin-left: 6px; font-size: 10px; font-weight: 600; border-radius: 9px; }
    .tab-badge-normal { background: var(--bg-tertiary); color: var(--text-secondary); }
    .tab-badge-orphan { background: var(--orphan-bg); color: var(--orphan-text); }
    .tab-panel { display: none; flex-direction: column; flex: 1; overflow: hidden; }
    .tab-panel.active { display: flex; }

    /* Orphaned Variables Section */
    .orphan-section { background: var(--orphan-bg); border: 1px solid var(--orphan-border); border-radius: 6px; padding: 12px; margin-bottom: 12px; }
    .orphan-section-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .orphan-section-icon { font-size: 16px; }
    .orphan-section-title { font-weight: 600; font-size: 12px; color: var(--orphan-text); }
    .orphan-section-desc { font-size: 11px; color: var(--orphan-text); opacity: 0.8; margin-bottom: 12px; line-height: 1.4; }
    .orphan-row { display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-medium); border-radius: 4px; margin-bottom: 6px; }
    .orphan-row:last-child { margin-bottom: 0; }
    .orphan-info { flex: 1; min-width: 0; }
    .orphan-property { font-size: 10px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; margin-bottom: 2px; }
    .orphan-nodes { font-size: 11px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .orphan-count { font-size: 10px; color: var(--text-tertiary); }
    .orphan-action { flex-shrink: 0; }

    /* Variable Picker Dropdown */
    .variable-picker { position: relative; }
    .variable-picker-btn { padding: 4px 8px; font-size: 11px; background: var(--accent-primary); color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
    .variable-picker-btn:hover { background: var(--accent-hover); }
    .variable-picker-dropdown { position: absolute; top: 100%; right: 0; margin-top: 4px; width: 280px; max-height: 240px; background: var(--bg-primary); border: 1px solid var(--border-medium); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: none; overflow: hidden; }
    .variable-picker-dropdown.visible { display: block; }
    .variable-picker-search { padding: 8px; border-bottom: 1px solid var(--border-medium); }
    .variable-picker-search input { width: 100%; padding: 6px 8px; border: 1px solid var(--border-strong); border-radius: 4px; font-size: 11px; background: var(--bg-secondary); color: var(--text-secondary); }
    .variable-picker-search input:focus { outline: none; border-color: var(--accent-primary); }
    .variable-picker-list { max-height: 180px; overflow-y: auto; }
    .variable-picker-item { padding: 8px 12px; font-size: 11px; font-family: 'SF Mono', 'Monaco', monospace; cursor: pointer; border-bottom: 1px solid var(--border-subtle); }
    .variable-picker-item:hover { background: var(--bg-hover); }
    .variable-picker-item:last-child { border-bottom: none; }
    .variable-picker-empty { padding: 16px; text-align: center; color: var(--text-disabled); font-size: 11px; }
    .variable-picker-list::-webkit-scrollbar { width: 8px; }
    .variable-picker-list::-webkit-scrollbar-track { background: var(--bg-secondary); }
    .variable-picker-list::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: 4px; }
  </style>
</head>
<body>
 <div class="container">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" id="tab-variables" onclick="switchTab('variables')">
        Variables <span class="tab-badge tab-badge-normal" id="tab-badge-variables">0</span>
      </button>
      <button class="tab" id="tab-orphaned" onclick="switchTab('orphaned')">
        Orphaned <span class="tab-badge tab-badge-orphan" id="tab-badge-orphaned">0</span>
      </button>
    </div>
    
    <!-- Variables Tab -->
    <div class="tab-panel active" id="panel-variables">
      <div class="find-replace-section">
        <div class="find-replace-row">
          <div class="input-group"><label>Find:</label><input type="text" id="find-input" placeholder="e.g. brand"></div>
          <div class="input-group"><label>Replace:</label><input type="text" id="replace-input" placeholder="e.g. neutral"></div>
          <button class="btn btn-apply-find-replace" id="apply-find-replace-btn">‚ñ∂ Preview</button>
        </div>
        <div class="find-replace-row options-row">
          <label class="checkbox-label"><input type="checkbox" id="whole-segment-checkbox" checked><span>Whole segment only</span></label>
          <label class="checkbox-label"><input type="checkbox" id="case-sensitive-checkbox" checked><span>Case sensitive</span></label>
        </div>
        <div class="preview-status-row hidden" id="preview-status-row">
          <span class="preview-status-success" id="preview-success-count"></span>
          <span class="preview-status-error" id="preview-error-count"></span>
          <span class="preview-status-info" id="preview-unchanged-count"></span>
        </div>
      </div>
      <div class="main-content">
        <div class="columns-header"><div>Current Variable</div><div>Remapped To</div></div>
        <div class="property-groups" id="property-groups">
          <div class="empty-state" id="empty-state">
            <div class="empty-state-icon">üéØ</div>
            <div class="empty-state-title">Select a component</div>
            <div class="empty-state-desc">Select one or more components to scan their bound variables</div>
          </div>
        </div>
        <div class="nested-instances-section hidden" id="nested-instances-section">
          <div class="nested-instances-title">‚ÑπÔ∏è Nested instances (edit at component source)</div>
          <div id="nested-instances-list"></div>
        </div>
      </div>
    </div>
    
    <!-- Orphaned Tab -->
    <div class="tab-panel" id="panel-orphaned">
      <div class="orphan-section">
        <div class="orphan-section-header">
          <span class="orphan-section-icon">‚ö†Ô∏è</span>
          <span class="orphan-section-title">Orphaned Variable Bindings</span>
        </div>
        <div class="orphan-section-desc">
          These bindings reference variables that don't exist in this file. This happens when you copy components from another file or delete variables that were still in use. Select a local variable to replace each orphaned binding.
        </div>
        <div id="orphaned-list"></div>
        <div class="empty-state" id="orphaned-empty" style="padding: 20px;">
          <div class="empty-state-icon">‚ú®</div>
          <div class="empty-state-title">No orphaned bindings</div>
          <div class="empty-state-desc">All variable bindings in your selection are valid</div>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <div class="footer-left">
        <button class="icon-button" id="theme-toggle">
          <span class="btn-tooltip">Toggle theme</span>
          <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M120,40V16a8,8,0,0,1,16,0V40a8,8,0,0,1-16,0Zm72,88a64,64,0,1,1-64-64A64.07,64.07,0,0,1,192,128Zm-16,0a48,48,0,1,0-48,48A48.05,48.05,0,0,0,176,128ZM58.34,69.66A8,8,0,0,0,69.66,58.34l-16-16A8,8,0,0,0,42.34,53.66Zm0,116.68-16,16a8,8,0,0,0,11.32,11.32l16-16a8,8,0,0,0-11.32-11.32ZM192,72a8,8,0,0,0,5.66-2.34l16-16a8,8,0,0,0-11.32-11.32l-16,16A8,8,0,0,0,192,72Zm5.66,114.34a8,8,0,0,0-11.32,11.32l16,16a8,8,0,0,0,11.32-11.32ZM48,128a8,8,0,0,0-8-8H16a8,8,0,0,0,0,16H40A8,8,0,0,0,48,128Zm80,80a8,8,0,0,0-8,8v24a8,8,0,0,0,16,0V216A8,8,0,0,0,128,208Zm112-88H216a8,8,0,0,0,0,16h24a8,8,0,0,0,0-16Z"></path></svg>
          <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256" style="display:none;"><path d="M233.54,142.23a8,8,0,0,0-8-2,88.08,88.08,0,0,1-109.8-109.8,8,8,0,0,0-10-10,104.84,104.84,0,0,0-52.91,37A104,104,0,0,0,136,224a103.09,103.09,0,0,0,62.52-20.88,104.84,104.84,0,0,0,37-52.91A8,8,0,0,0,233.54,142.23ZM188.9,190.34A88,88,0,0,1,65.66,67.11a89,89,0,0,1,31.4-26A106,106,0,0,0,96,56,104.11,104.11,0,0,0,200,160a106,106,0,0,0,14.92-1.06A89,89,0,0,1,188.9,190.34Z"></path></svg>
        </button>
        <span class="footer-stats" id="footer-stats">0 unique variables</span>
      </div>
      <div class="footer-right">
        <div class="undo-redo-group">
          <button class="icon-button" id="undo-btn" disabled><span class="btn-tooltip">Undo</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a96,96,0,0,1-96,96H64a8,8,0,0,1,0-16h64a80,80,0,0,0,0-160H51.31l18.35,18.34a8,8,0,1,1-11.32,11.32l-32-32a8,8,0,0,1,0-11.32l32-32A8,8,0,0,1,69.66,13.66L51.31,32H128A96.11,96.11,0,0,1,224,128Z"></path></svg></button>
          <button class="icon-button" id="redo-btn" disabled><span class="btn-tooltip">Redo</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M32,128A96.11,96.11,0,0,1,128,32h76.69L186.34,13.66a8,8,0,0,1,11.32-11.32l32,32a8,8,0,0,1,0,11.32l-32,32a8,8,0,0,1-11.32-11.32L204.69,48H128a80,80,0,0,0,0,160h64a8,8,0,0,1,0,16H128A96,96,0,0,1,32,128Z"></path></svg></button>
          <button class="icon-button" id="history-btn"><span class="btn-tooltip">History</span><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"></path></svg></button>
        </div>
        <button class="btn btn-primary" id="apply-changes-btn" disabled>Apply 0 Changes</button>
      </div>
    </div>
    
    <div class="history-panel" id="history-panel">
      <div class="history-panel-header">
        <span class="history-panel-title">History</span>
        <span class="history-panel-warning">Clears when plugin closes</span>
        <button class="history-panel-close" id="history-close">‚úï</button>
      </div>
      <div class="history-panel-content" id="history-content"><div class="history-empty">No changes yet</div></div>
    </div>
  </div>
  
  <div class="dialog-overlay hidden" id="unsaved-dialog">
    <div class="dialog-box">
      <div class="dialog-title">Unsaved Changes</div>
      <div class="dialog-message">You have unsaved remapping changes. Selecting a new element will discard them.</div>
      <div class="dialog-actions"><button class="btn" id="dialog-stay">Stay</button><button class="btn btn-primary" id="dialog-proceed">Proceed</button></div>
    </div>
  </div>
  <svg id="resize-corner" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 256 256"><path d="M213.66,133.66l-80,80a8,8,0,0,1-11.32-11.32l80-80a8,8,0,0,1,11.32,11.32Zm-16-99.32a8,8,0,0,0-11.32,0l-152,152a8,8,0,0,0,11.32,11.32l152-152A8,8,0,0,0,197.66,34.34Z"></path></svg>
  
  <script>
    var currentBindings = [], orphanedBindings = [], selectedBindingKeys = new Set(), previewResults = new Map();
    var nestedInstances = [], localCollections = [], allLocalVariables = {};
    var hasUnsavedChanges = false, currentTheme = 'light', historyData = [], historyIndex = -1;
    var activeOrphanPicker = null;

    var propertyTypeLabels = { fill: 'Fill Colors', stroke: 'Stroke Colors', effect: 'Effect Colors', text: 'Text Colors', spacing: 'Spacing', cornerRadius: 'Corner Radius', typography: 'Typography', other: 'Other' };
    var propertyTypeOrder = ['fill', 'stroke', 'effect', 'text', 'spacing', 'cornerRadius', 'typography', 'other'];

    function init() {
      document.getElementById('apply-find-replace-btn').addEventListener('click', applyFindReplace);
      document.getElementById('find-input').addEventListener('keyup', function(e) { if (e.key === 'Enter') applyFindReplace(); });
      document.getElementById('replace-input').addEventListener('keyup', function(e) { if (e.key === 'Enter') applyFindReplace(); });
      document.getElementById('apply-changes-btn').addEventListener('click', applyChanges);
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
      document.getElementById('undo-btn').addEventListener('click', function() { parent.postMessage({ pluginMessage: { type: 'undo' } }, '*'); });
      document.getElementById('redo-btn').addEventListener('click', function() { parent.postMessage({ pluginMessage: { type: 'redo' } }, '*'); });
      document.getElementById('history-btn').addEventListener('click', function() { document.getElementById('history-panel').classList.toggle('visible'); });
      document.getElementById('history-close').addEventListener('click', function() { document.getElementById('history-panel').classList.remove('visible'); });
      document.getElementById('dialog-stay').addEventListener('click', function() { document.getElementById('unsaved-dialog').classList.add('hidden'); });
      document.getElementById('dialog-proceed').addEventListener('click', function() { document.getElementById('unsaved-dialog').classList.add('hidden'); hasUnsavedChanges = false; previewResults.clear(); parent.postMessage({ pluginMessage: { type: 'scan-selection' } }, '*'); });
      document.addEventListener('click', function(e) { if (activeOrphanPicker !== null && !e.target.closest('.variable-picker')) closeAllPickers(); });
      setupResizeHandle();
    }

    function setupResizeHandle() {
      var corner = document.getElementById('resize-corner');
      corner.addEventListener('pointerdown', function(e) {
        corner.onpointermove = function(ev) { parent.postMessage({ pluginMessage: { type: 'resize', size: { w: Math.max(500, Math.floor(ev.clientX + 5)), h: Math.max(400, Math.floor(ev.clientY + 5)) } } }, '*'); };
        corner.setPointerCapture(e.pointerId);
      });
      corner.addEventListener('pointerup', function(e) { corner.onpointermove = null; corner.releasePointerCapture(e.pointerId); });
    }

    function toggleTheme() {
      currentTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
      document.getElementById('sun-icon').style.display = currentTheme === 'dark' ? 'none' : 'block';
      document.getElementById('moon-icon').style.display = currentTheme === 'dark' ? 'block' : 'none';
    }

    window.switchTab = function(tab) {
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
      document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('panel-' + tab).classList.add('active');
    };

    window.onmessage = function(event) {
      var msg = event.data.pluginMessage;
      if (!msg) return;
      switch (msg.type) {
        case 'scan-complete': handleScanComplete(msg.result); break;
        case 'selection-changed': if (hasUnsavedChanges) document.getElementById('unsaved-dialog').classList.remove('hidden'); else parent.postMessage({ pluginMessage: { type: 'scan-selection' } }, '*'); break;
        case 'preview-result': handlePreviewResult(msg.previews); break;
        case 'apply-complete': case 'orphan-remap-complete': hasUnsavedChanges = false; previewResults.clear(); document.getElementById('find-input').value = ''; document.getElementById('replace-input').value = ''; updatePreviewStatus(); break;
        case 'history-update': historyData = msg.history; historyIndex = msg.historyIndex; document.getElementById('undo-btn').disabled = msg.historyIndex < 0; document.getElementById('redo-btn').disabled = msg.historyIndex >= msg.history.length - 1; renderHistory(); break;
        case 'all-local-variables': allLocalVariables = msg.variablesByCollection; localCollections = msg.collections; break;
      }
    };

    function handleScanComplete(result) {
      currentBindings = result.bindings;
      orphanedBindings = result.orphanedBindings || [];
      nestedInstances = result.nestedInstances;
      localCollections = result.localCollections || [];
      selectedBindingKeys.clear();
      previewResults.clear();
      hasUnsavedChanges = false;
      currentBindings.forEach(function(b) { selectedBindingKeys.add(getBindingKey(b)); });
      
      document.getElementById('tab-badge-variables').textContent = currentBindings.length;
      document.getElementById('tab-badge-orphaned').textContent = orphanedBindings.length;
      
      if (orphanedBindings.length > 0) {
        parent.postMessage({ pluginMessage: { type: 'get-all-local-variables' } }, '*');
      }
      
      renderBindings();
      renderOrphanedBindings();
      renderNestedInstances();
      updateFooter();
      updatePreviewStatus();
    }

    function handlePreviewResult(previews) {
      previewResults.clear();
      previews.forEach(function(p) { previewResults.set(getBindingKey(p.binding), p); });
      hasUnsavedChanges = previews.some(function(p) { return p.status === 'found'; });
      renderBindings();
      updateFooter();
      updatePreviewStatus();
    }

    function applyFindReplace() {
      var findText = document.getElementById('find-input').value.trim();
      if (!findText) return;
      var selectedBindings = currentBindings.filter(function(b) { return selectedBindingKeys.has(getBindingKey(b)); });
      parent.postMessage({ pluginMessage: { type: 'preview-remap', findText: findText, replaceText: document.getElementById('replace-input').value.trim(), options: { wholeSegment: document.getElementById('whole-segment-checkbox').checked, caseSensitive: document.getElementById('case-sensitive-checkbox').checked }, selectedBindings: selectedBindings } }, '*');
    }

    function applyChanges() {
      var remaps = [];
      previewResults.forEach(function(preview, key) {
        if (preview.status === 'found' && selectedBindingKeys.has(key)) {
          remaps.push({ propertyKey: preview.binding.propertyKey, propertyType: preview.binding.propertyType, oldVariableId: preview.binding.variableId, oldVariableName: preview.binding.variableName, newVariableId: preview.newVariableId, newVariableName: preview.newVariableName, nodeIds: preview.binding.nodeIds });
        }
      });
      if (remaps.length > 0) parent.postMessage({ pluginMessage: { type: 'apply-remap', remaps: remaps } }, '*');
    }

    function renderBindings() {
      var container = document.getElementById('property-groups');
      var emptyState = document.getElementById('empty-state');
      if (currentBindings.length === 0) { container.innerHTML = ''; container.appendChild(emptyState); emptyState.style.display = 'flex'; return; }
      emptyState.style.display = 'none';
      var groups = {};
      propertyTypeOrder.forEach(function(type) { groups[type] = { label: propertyTypeLabels[type], items: [] }; });
      currentBindings.forEach(function(b) { (groups[b.propertyType] || groups['other']).items.push(b); });
      var html = '';
      propertyTypeOrder.forEach(function(type) {
        var group = groups[type];
        if (group.items.length === 0) return;
        html += '<div class="property-group"><div class="property-group-header" onclick="toggleGroup(\'' + type + '\')"><div class="property-group-header-left"><span class="property-group-toggle" id="toggle-' + type + '">‚ñº</span><span class="property-group-title">' + group.label + '</span><span class="property-group-count">(' + group.items.length + ')</span></div><button class="select-all-btn" onclick="event.stopPropagation(); toggleSelectAll(\'' + type + '\')">Select All</button></div><div class="property-group-items expanded" id="items-' + type + '">';
        group.items.forEach(function(binding) {
          var key = getBindingKey(binding), isSelected = selectedBindingKeys.has(key), preview = previewResults.get(key);
          var previewHtml = '<span class="status-unchanged">(no change)</span>', statusIcon = '';
          if (preview) {
            if (preview.status === 'found') { previewHtml = '<span class="status-found">' + escapeHtml(preview.newVariableName) + '</span>'; statusIcon = '<span class="tooltip-wrapper"><span class="status-icon status-icon-success">‚úì</span><span class="tooltip">Ready to apply</span></span>'; }
            else if (preview.status === 'not_found') { previewHtml = '<span class="status-not-found">' + escapeHtml(preview.newVariableName) + '</span>'; statusIcon = '<span class="tooltip-wrapper"><span class="status-icon status-icon-error">!</span><span class="tooltip tooltip-left">Variable not found</span></span>'; }
          }
          var countBadge = binding.nodeCount > 1 ? '<span class="tooltip-wrapper"><span class="binding-count">√ó' + binding.nodeCount + '</span><span class="tooltip">' + binding.nodeCount + ' elements</span></span>' : '';
          html += '<div class="binding-row"><div class="binding-cell"><input type="checkbox" class="binding-checkbox" ' + (isSelected ? 'checked' : '') + ' onchange="toggleBinding(\'' + key + '\')"><span class="binding-name" title="' + escapeHtml(binding.variableName) + '">' + escapeHtml(binding.variableName) + '</span>' + countBadge + '</div><div class="binding-cell"><span class="binding-preview">' + previewHtml + '</span>' + statusIcon + '</div></div>';
        });
        html += '</div></div>';
      });
      container.innerHTML = html;
    }

    function renderOrphanedBindings() {
      var list = document.getElementById('orphaned-list');
      var empty = document.getElementById('orphaned-empty');
      if (orphanedBindings.length === 0) { list.innerHTML = ''; empty.style.display = 'flex'; return; }
      empty.style.display = 'none';
      var html = '';
      orphanedBindings.forEach(function(orphan, index) {
        var nodeNames = orphan.nodeNames.slice(0, 3).join(', ') + (orphan.nodeNames.length > 3 ? '...' : '');
        html += '<div class="orphan-row"><div class="orphan-info"><div class="orphan-property">' + propertyTypeLabels[orphan.propertyType] + '</div><div class="orphan-nodes" title="' + escapeHtml(orphan.nodeNames.join(', ')) + '">' + escapeHtml(nodeNames) + '</div><div class="orphan-count">' + orphan.nodeCount + ' binding' + (orphan.nodeCount !== 1 ? 's' : '') + '</div></div><div class="orphan-action"><div class="variable-picker" id="picker-' + index + '"><button class="variable-picker-btn" onclick="togglePicker(' + index + ', \'' + orphan.propertyType + '\')">Select Variable ‚ñæ</button><div class="variable-picker-dropdown" id="dropdown-' + index + '"><div class="variable-picker-search"><input type="text" placeholder="Search variables..." oninput="filterVariables(' + index + ', this.value)"></div><div class="variable-picker-list" id="list-' + index + '"></div></div></div></div></div>';
      });
      list.innerHTML = html;
    }

    window.togglePicker = function(index, propertyType) {
      var dropdown = document.getElementById('dropdown-' + index);
      var isVisible = dropdown.classList.contains('visible');
      closeAllPickers();
      if (!isVisible) {
        dropdown.classList.add('visible');
        activeOrphanPicker = index;
        populateVariableList(index, propertyType, '');
      }
    };

    function closeAllPickers() { document.querySelectorAll('.variable-picker-dropdown').forEach(function(d) { d.classList.remove('visible'); }); activeOrphanPicker = null; }

    function populateVariableList(index, propertyType, filter) {
      var list = document.getElementById('list-' + index);
      var varType = ['fill', 'stroke', 'effect', 'text'].indexOf(propertyType) !== -1 ? 'COLOR' : 'FLOAT';
      var html = '';
      var hasItems = false;
      localCollections.forEach(function(collection) {
        var vars = allLocalVariables[collection.id] || [];
        vars.forEach(function(v) {
          if (v.resolvedType === varType && (!filter || v.name.toLowerCase().indexOf(filter.toLowerCase()) !== -1)) {
            hasItems = true;
            html += '<div class="variable-picker-item" onclick="applyOrphanRemap(' + index + ', \'' + v.id.replace(/'/g, "\\'") + '\', \'' + v.name.replace(/'/g, "\\'") + '\')">' + escapeHtml(v.name) + '</div>';
          }
        });
      });
      list.innerHTML = hasItems ? html : '<div class="variable-picker-empty">No matching variables</div>';
    }

    window.filterVariables = function(index, filter) {
      var orphan = orphanedBindings[index];
      populateVariableList(index, orphan.propertyType, filter);
    };

    window.applyOrphanRemap = function(index, variableId, variableName) {
      var orphan = orphanedBindings[index];
      closeAllPickers();
      parent.postMessage({ pluginMessage: { type: 'apply-orphan-remap', orphanedBinding: orphan, newVariableId: variableId, newVariableName: variableName } }, '*');
    };

    function renderNestedInstances() {
      var section = document.getElementById('nested-instances-section');
      if (nestedInstances.length === 0) { section.classList.add('hidden'); return; }
      section.classList.remove('hidden');
      document.getElementById('nested-instances-list').innerHTML = nestedInstances.map(function(ni) { return '<div>‚Ä¢ ' + escapeHtml(ni.nodeName) + ' ‚Üí ' + escapeHtml(ni.mainComponentName) + ' (' + ni.boundVariableCount + ' vars)</div>'; }).join('');
    }

    function renderHistory() {
      var content = document.getElementById('history-content');
      if (historyData.length === 0) { content.innerHTML = '<div class="history-empty">No changes yet</div>'; return; }
      content.innerHTML = historyData.slice().reverse().map(function(entry, i) {
        var realIndex = historyData.length - 1 - i;
        var cls = 'history-item' + (realIndex === historyIndex ? ' current' : '') + (realIndex > historyIndex ? ' future' : '');
        return '<div class="' + cls + '"><div>' + escapeHtml(entry.description) + '</div><div class="history-item-time">' + new Date(entry.timestamp).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}) + '</div></div>';
      }).join('');
    }

    function updatePreviewStatus() {
      var row = document.getElementById('preview-status-row');
      if (previewResults.size === 0) { row.classList.add('hidden'); return; }
      row.classList.remove('hidden');
      var found = 0, notFound = 0;
      previewResults.forEach(function(p, k) { if (selectedBindingKeys.has(k)) { if (p.status === 'found') found++; else if (p.status === 'not_found') notFound++; } });
      document.getElementById('preview-success-count').textContent = found > 0 ? '‚úì ' + found + ' ready' : '';
      document.getElementById('preview-success-count').style.display = found > 0 ? 'inline' : 'none';
      document.getElementById('preview-error-count').textContent = notFound > 0 ? '‚ö† ' + notFound + ' not found' : '';
      document.getElementById('preview-error-count').style.display = notFound > 0 ? 'inline' : 'none';
    }

    function updateFooter() {
      var total = 0; currentBindings.forEach(function(b) { if (selectedBindingKeys.has(getBindingKey(b))) total += b.nodeCount; });
      document.getElementById('footer-stats').textContent = selectedBindingKeys.size + ' variables (' + total + ' usages)';
      var found = 0; previewResults.forEach(function(p, k) { if (p.status === 'found' && selectedBindingKeys.has(k)) found++; });
      document.getElementById('apply-changes-btn').disabled = found === 0;
      document.getElementById('apply-changes-btn').textContent = 'Apply ' + found + ' Change' + (found !== 1 ? 's' : '');
    }

    function getBindingKey(b) { return b.propertyType + ':' + b.propertyKey + ':' + b.variableId; }
    function escapeHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    window.toggleGroup = function(type) { var items = document.getElementById('items-' + type); var toggle = document.getElementById('toggle-' + type); items.classList.toggle('expanded'); toggle.textContent = items.classList.contains('expanded') ? '‚ñº' : '‚ñ∂'; };
    window.toggleSelectAll = function(type) { var group = currentBindings.filter(function(b) { return b.propertyType === type; }); var allSel = group.every(function(b) { return selectedBindingKeys.has(getBindingKey(b)); }); group.forEach(function(b) { var k = getBindingKey(b); if (allSel) selectedBindingKeys.delete(k); else selectedBindingKeys.add(k); }); renderBindings(); updateFooter(); updatePreviewStatus(); };
    window.toggleBinding = function(key) { if (selectedBindingKeys.has(key)) selectedBindingKeys.delete(key); else selectedBindingKeys.add(key); updateFooter(); updatePreviewStatus(); };
    init();
  </script>
</body>
</html>
